name: install-deps

runs:
  using: 'composite'
  steps:
    ### OTHER REPOS ####
    # turn off interactive, refresh pkgs
    - run: |
        echo 'debconf debconf/frontend select Noninteractive' | sudo debconf-set-selections
        sudo rm /var/lib/man-db/auto-update
        sudo apt-get update -y
        sudo apt-get install -y tasksel
        sudo tasksel remove ubuntu-desktop
      shell: bash

    ### DOWNLOAD AND INSTALL DEPENDENCIES ###

    # Download dependencies packaged by Ubuntu
    - run: |
        sudo apt install -f -y bison busybox-static cmake coreutils \
        cpio elfutils file flex gcc gcc-multilib git iproute2 jq kbd kmod \
        libcap-dev libelf-dev libunwind-dev libvirt-clients libzstd-dev \
        linux-headers-generic linux-tools-common linux-tools-generic make \
        ninja-build pahole pkg-config python3-dev python3-pip python3-requests \
        qemu-kvm rsync stress-ng udev zstd libseccomp-dev libcap-ng-dev \
        llvm libllvm-18-ocaml-dev libllvm18 llvm-18 llvm-18-dev llvm-18-doc \
        llvm-18-examples llvm-18-runtime clang-18 clang-tools-18 libclang-common-18-dev \
        libclang-18-dev libclang1-18 lld-18 lldb-18 clang-format-18 python3-clang-18 \
        python3-full curl meson bpftrace cargo rustc dwarves
      shell: bash

    # virtme-ng
    - run: sudo pip3 install virtme-ng --break-system-packages
      shell: bash

    # Setup KVM support
    - run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
      shell: bash

    ### END DEPENDENCIES ###
