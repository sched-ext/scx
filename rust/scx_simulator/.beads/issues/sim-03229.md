---
title: 'Task stranding after cgroup_migrate: task stuck in old cell DSQ'
status: open
priority: 1
issue_type: task
created_at: 2026-02-21T21:38:18.067608875+00:00
updated_at: 2026-02-21T21:38:18.067608875+00:00
---

# Description

## Problem

After `cgroup_migrate`, a task's BPF metadata (`tctx->cell`, `tctx->dsq`) is updated to the new cell, but the task remains physically enqueued in the old cell's DSQ in the DsqManager. No CPU in the new cell will consume from the old cell's DSQ, so the task is stranded.

### Sequence

1. Task T in cgroup A (cell 0), enqueued in cell 0's DSQ
2. CgroupMigrate moves T to cgroup B (cell 1)
3. `handle_cgroup_migrate` calls `mitosis_cgroup_move` — updates `tctx->cell = 1`, `tctx->dsq = cell_1_dsq`
4. Task T still physically in cell 0's DSQ
5. Cell 1 CPUs see empty DSQ, go idle. Task is stranded.

### Two-layer issue

Simulator: `handle_cgroup_migrate` only calls the BPF callback — no `process_kicked_cpus`, no re-enqueue, no DSQ removal.

Scheduler: In the real kernel, `cgroup_move` doesn't dequeue/re-enqueue. The task's DSQ is corrected on the next `enqueue` via `maybe_refresh_cell`. Bug only manifests when migration happens while the task is already queued.

### Potential fixes

1. Simulator: After `cgroup_move`, if task is runnable-queued, remove from old DSQ and re-enqueue
2. Simulator: After `cgroup_move`, kick the task's CPU to trigger re-dispatch
3. Investigate real kernel behavior for sched_ext cgroup migrations

## Key files

- engine.rs — `handle_cgroup_migrate` (line 1499)
- mitosis.bpf.c — `mitosis_cgroup_move` (line 1477), `update_task_cell` (line 456)
- dsq.rs — `DsqManager`

Related: sim-b7d70 (test_mitosis_dynamic_cell_lifecycle documents this).
