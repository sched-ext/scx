---
title: 'Mitosis coverage tracking: current state and remaining gaps'
status: open
priority: 1
issue_type: task
created_at: 2026-02-19T08:55:46.638671911+00:00
updated_at: 2026-02-19T08:55:46.638671911+00:00
---

## Current State (2026-02-19)

**File:** `scheds/rust/scx_mitosis/src/bpf/mitosis.bpf.c` (1892 lines, 1090 executable)

| Metric     | Value  |
|------------|--------|
| Function   | 75.47% (40/53) |
| Line       | 51.80% (565/1090) |
| Branch     | 41.43% (203/490) |

**52 integration tests** in `tests/mitosis.rs` (2146 lines).

### Coverage Progression

| Milestone                    | Function | Line   | Branch |
|------------------------------|----------|--------|--------|
| Baseline (no mitosis tests)  | 53.85%   | 39.19% | 28.04% |
| +22 initial tests            | 53.85%   | 40.83% | 32.51% |
| +timer bridging + 8 tests    | 64.15%   | 42.95% | 32.86% |
| +11 global-variable tests    | 64.15%   | 43.13% | 33.67% |
| +dump/set_cpumask/dump_task  | 75.47%   | 51.71% | 40.82% |
| +3 large-CPU tests           | 75.47%   | 51.80% | 41.43% |

### Ops Loaded by Simulator

Mandatory: `init`, `select_cpu`, `enqueue`, `dispatch`, `running`, `stopping`.
Optional (loaded): `enable`, `init_task`, `exit`, `fire_timer`, `dequeue`,
`quiescent`, `tick`, `set_cpumask`, `dump`, `dump_task`.
**Not loaded:** `cgroup_init`, `cgroup_exit`, `cgroup_move`, `exit_task`,
`tp_cgroup_mkdir`, `tp_cgroup_rmdir`, `fentry_cpuset_write_resmask`.

## Uncovered Lines Breakdown (525 lines)

All 525 remaining uncovered lines are **structurally unreachable** given the
current simulator architecture. No further test-level changes can improve
coverage without architectural changes.

### 1. Error Paths — 152 lines (29.0%)

Simulator lookups (`lookup_task_ctx`, `lookup_cpu_ctx`, `lookup_cell`,
`lookup_cell_cpumask`, `lookup_cgrp_ctx`) and allocations (`bpf_cpumask_create`,
`bpf_cgrp_storage_get`) always succeed. Map lookups via `bpf_map_lookup_elem`
route to static arrays that never return NULL for valid indices.
`bpf_timer_start` is overridden to always return 0.

Includes: all `scx_bpf_error()` guard clauses in every function, zero-weight
check in `stopping` (line 1242), vtime-too-far-ahead check in `enqueue` (line
727), kptr exchange "should never be null" checks throughout `init` and
`update_timer_cb`.

### 2. Never-Called Functions — 184 lines (35.0%)

Functions whose **callers** are themselves unreachable:

| Function                       | Lines     | Count | Why Unreachable                                 |
|--------------------------------|-----------|-------|-------------------------------------------------|
| `get_cgroup_cpumask`           | 885-939   | 46    | Only from timer CSS body + `init_cgrp_ctx`      |
| `init_cgrp_ctx`                | 1302-1347 | 34    | `cgroup_init` not loaded; CSS iterator empty     |
| `record_cgroup_exit`           | 332-349   | 14    | Only from unloaded `cgroup_exit`/`tp_rmdir`     |
| `record_cgroup_init`           | 291-308   | 14    | Only from `init_cgrp_ctx` (never called)        |
| `allocate_cell`                | 254-269   | 15    | Only from timer CSS body                        |
| `init_cgrp_ctx_with_ancestors` | 1361-1386 | 16    | Loop body: root cgroup at level 0, no ancestors |
| `free_cell`                    | 272-285   | 11    | Only from unloaded `cgroup_exit`/`tp_rmdir`     |
| `lookup_cgrp_ancestor`         | 101-111   | 9     | Only from `init_cgrp_ctx`                       |
| `pick_idle_cpu` empty path     | 603-607   | 5     | Requires cell/task cpumask disjoint (single cell)|
| `allocate_cpumask_entry`       | 838-845   | 4     | Only from timer body + `init_cgrp_ctx`          |
| Dump debug event cases         | 1662-1698 | 16    | `CGROUP_INIT`/`EXIT` events never recorded      |

### 3. CSS Iterator Body — 89 lines (17.0%)

`bpf_for_each(css, cur, root, flags)` is stubbed as `for (cur = NULL; cur != NULL; )`
in `sim_wrapper.h:187-188`. The loop body never executes.

Affects two locations:
- **Timer callback** (lines 1033-1142): 81 lines. The core cell-reconfiguration
  logic that walks the cgroup tree, reads cpusets, allocates cells, and assigns
  CPUs. This is the heart of mitosis's dynamic behavior.
- **`mitosis_init`** (lines 1796-1810): 8 lines. Initializes cgrp_ctx for all
  existing cgroups at scheduler load time.

### 4. Unloaded Ops — 61 lines (11.6%)

Ops that the simulator does not load, and tracepoint/fentry programs that
the simulator cannot invoke:

| Op/Program                      | Lines       | Count |
|---------------------------------|-------------|-------|
| `mitosis_cgroup_exit`           | 1402-1432   | 18    |
| `tp_cgroup_rmdir`               | 1470-1500   | 16    |
| `tp_cgroup_mkdir`               | 1454-1466   | 12    |
| `mitosis_cgroup_move`           | 1436-1446   | 8     |
| `mitosis_cgroup_init`           | 1395-1399   | 3     |
| `fentry_cpuset_write_resmask`   | 1273-1280   | 4     |

### 5. Dead Code from Wrapper Overrides — 39 lines (7.4%)

| Override                           | Lines     | Count | Effect                              |
|------------------------------------|-----------|-------|-------------------------------------|
| `__COMPAT_is_enq_cpu_selected`=true| 689-704,745| 13   | Enqueue idle-CPU fallback is dead   |
| `exiting_task_workaround`=false    | 482-500   | 17    | Exiting-task fallback never fires   |
| `reject_multicpu_pinning`=false    | 432-435   | 4     | Pinning rejection never fires       |
| Single-cgroup model                | 581,656,794| 3    | cgid change, cpumask fallback, race |
| Preprocessor constants             | 815-816   | 2     | `#define`, not executable           |

## Path to Higher Coverage

The single largest improvement would be **cgroup lifecycle modeling** (sim-6e3e2),
which would unlock approximately **256 lines** and raise line coverage from
51.8% to an estimated **75.3%**.

After cgroup support, the remaining ~117 uncovered lines would be:
- Error paths (152 lines minus ~35 that become reachable through cgroup paths): ~117
- `fentry_cpuset_write_resmask` (4 lines): requires fentry modeling
- Wrapper-override dead code that persists (e.g., `__COMPAT_is_enq_cpu_selected`): ~13
