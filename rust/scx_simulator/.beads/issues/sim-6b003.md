---
title: Real-vs-simulated trace comparison reveals 6 realism gaps
status: open
priority: 2
issue_type: task
labels:
- realism
created_at: 2026-02-17T22:20:55.141401646+00:00
updated_at: 2026-02-17T22:20:55.141401646+00:00
---

# Description

Ran scx_mitosis on a real host with two_runners.json (heavy at nice -5, light at nice 0, 2 CPUs) traced via bpftrace, then ran the same workload in the simulator. Comparing the ~5400-line real trace to the ~4800-line simulated trace reveals the following gaps:

## Gap 1: Spurious yield/re-enqueue cycle (MOST IMPORTANT)

The simulator runs 98 cycles of: stopping(still_runnable=true) -> enqueue(yield re-enqueue) -> dsq_insert_vtime(DSQ 0) -> dsq_move_to_local -> running. This NEVER happens in the real trace for CPU-bound tasks. In reality, heavy/light are always dispatched directly from select_cpu via SCX_DSQ_LOCAL_ON â€” they never enter the yield/vtime-dispatch path. The simulator's Phase::RunFor + Phase::Wake workload model triggers a yield at phase boundaries, exercising a completely different mitosis code path than the real kernel. Real tasks never hit dispatch() ops at all (fully handled by direct dispatch in select_cpu).

## Gap 2: Tick frequency mismatch

Real kernel: 1ms ticks (HZ=1000), ~10 ticks per 10ms heavy run. Simulator: ~4ms ticks, only ~2 ticks per run. The jitter pattern (alternating ~4ms and ~16ms) doesn't match real kernel tick cadence.

## Gap 3: No system noise / competing tasks

Real trace has 85 distinct PIDs on CPUs 0-1 (V8Worker, dogpile-ticker, kworkers, ThriftIO, etc.). System tasks occasionally preempt heavy (kworker preempts 3 times on CPU 0), causing run durations to vary (10.47-10.72ms vs exactly 10.000ms in sim). The simulator has only the 2 workload tasks.

## Gap 4: Missing kfunc trace events

Real mitosis calls pick_idle_cpu (48x), kick_cpu (31x), task_cpu (30x), and scx_bpf_consume (28x). These kfuncs either aren't modeled or aren't traced in the simulator.

## Gap 5: Per-tick coordinator dispatch

Every task_tick in the real trace triggers select_task_rq + dispatch for a monitoring/coordinator PID (830 events total). Mitosis appears to proactively re-dispatch a coordinator task on every tick. The simulator doesn't model this.

## Gap 6: Run duration variance

Real: 10.47-10.72ms variance from kernel overhead, interrupts. Sim: exactly 10.000ms, no variance. (Partially addressed by the CSW overhead noise model, but no interrupt/IRQ jitter.)

## What matches well

- CPU affinity: heavy always on CPU 0, light always on CPU 1
- Run duration ratios: 2:1 (heavy 10ms, light 5ms)
- Sleep durations: ~10ms idle for heavy, ~15ms for light
- Direct dispatch via SCX_DSQ_LOCAL_ON from select_cpu on wake
- DSQ creation (mitosis creates DSQs 0-258 on init)
- Overall scheduling pattern (run, sleep, wake, run)
